---
description: Project infrastructure decisions and setup conventions for ESLint plugins with TypeScript
globs: ["**/*"]
alwaysApply: true
---

# Project Infrastructure

This document captures infrastructure decisions for an ESLint plugin written in TypeScript.

## General Principles

### Lean Configuration

- **No redundant options**: Don't repeat values that are already implied by other settings
- **No default values**: Don't explicitly set options that match the tool's default behavior
- **Composite options first**: Use umbrella options like `strict` instead of individual flags they enable

## Node.js & Package Manager

- **Node.js**: Minimum version 24 (Current)
- **Package Manager**: npm (standard, no lock file preference)
- **Module System**: ESM (`"type": "module"` in package.json)

## TypeScript Configuration

### Compiler Options

Only specify options beyond `strict: true`. The `strict` flag enables:
`alwaysStrict`, `strictNullChecks`, `strictBindCallApply`, `strictFunctionTypes`,
`strictPropertyInitialization`, `noImplicitAny`, `noImplicitThis`, `useUnknownInCatchVariables`

```json
{
  "compilerOptions": {
    "target": "ES2023",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "strict": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "exactOptionalPropertyTypes": true,
    "forceConsistentCasingInFileNames": true,
    "verbatimModuleSyntax": true
  }
}
```

### Options Reference

| Option | Description |
|--------|-------------|
| [`strict`](https://www.typescriptlang.org/tsconfig/#strict) | Enable all strict type-checking options |
| [`noImplicitReturns`](https://www.typescriptlang.org/tsconfig/#noImplicitReturns) | Report error when not all code paths in function return a value |
| [`noFallthroughCasesInSwitch`](https://www.typescriptlang.org/tsconfig/#noFallthroughCasesInSwitch) | Report errors for fallthrough cases in switch statements |
| [`noUncheckedIndexedAccess`](https://www.typescriptlang.org/tsconfig/#noUncheckedIndexedAccess) | Add `undefined` to any un-declared field in an index signature |
| [`noUnusedLocals`](https://www.typescriptlang.org/tsconfig/#noUnusedLocals) | Report errors on unused local variables |
| [`noUnusedParameters`](https://www.typescriptlang.org/tsconfig/#noUnusedParameters) | Report errors on unused parameters in functions |
| [`exactOptionalPropertyTypes`](https://www.typescriptlang.org/tsconfig/#exactOptionalPropertyTypes) | Interpret optional property types as written, not adding `undefined` |
| [`forceConsistentCasingInFileNames`](https://www.typescriptlang.org/tsconfig/#forceConsistentCasingInFileNames) | Ensure imports match the casing of files on disk |
| [`verbatimModuleSyntax`](https://www.typescriptlang.org/tsconfig/#verbatimModuleSyntax) | Preserve import/export syntax; require `type` modifier for type-only imports |

## ESLint Configuration

### Using ESLint 9 Flat Config with TypeScript

The project uses `typescript-eslint` v8+ with the new flat config format (array-style, not deprecated `tseslint.config()`).

```ts
import eslint from "@eslint/js"
import tseslint from "typescript-eslint"

export default [
  eslint.configs.recommended,
  ...tseslint.configs.strictTypeChecked,
  ...tseslint.configs.stylisticTypeChecked,
  {
    languageOptions: {
      parserOptions: {
        projectService: {
          allowDefaultProject: ["*.config.ts"],
        },
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
]
```

### Required Dev Dependencies for ESLint + TypeScript

```json
{
  "@eslint/js": "^9.x",
  "eslint": "^9.x",
  "jiti": "^2.x",
  "typescript-eslint": "^8.x"
}
```

Note: `jiti` is required by ESLint 9 for loading TypeScript config files (`eslint.config.ts`).

### Key Rules Enabled

- `@typescript-eslint/explicit-function-return-type`: All functions must have explicit return types
- `@typescript-eslint/consistent-type-imports`: Use `type` keyword for type-only imports
- `@typescript-eslint/consistent-type-definitions`: Prefer `interface` over `type` aliases
- `@typescript-eslint/no-unnecessary-condition`: Catch always-truthy/falsy conditions
- `@typescript-eslint/strict-boolean-expressions`: No implicit boolean coercion

## Prettier Configuration

**All code must be Prettier-formatted.** This is enforced by pre-commit hooks and CI.

```json
{
  "semi": false,
  "singleQuote": false,
  "tabWidth": 2,
  "useTabs": false,
  "trailingComma": "none",
  "printWidth": 120,
  "bracketSpacing": true,
  "arrowParens": "always",
  "endOfLine": "lf"
}
```

### Key Decisions

- **No semicolons**: Cleaner code, ASI handles insertion
- **Double quotes**: Aligns with JSON, cleaner for strings containing apostrophes
- **2 spaces**: Standard for JavaScript/TypeScript ecosystem
- **No trailing commas**: Cleaner appearance
- **120 character line width**: Modern screens, reduces line breaks in complex types
- **LF line endings**: Unix-style, consistent across platforms

## Pre-commit Hooks

### Husky + lint-staged

The project uses Husky for Git hooks and lint-staged for running checks on staged files.

```bash
# .husky/pre-commit
npx lint-staged
npm run typecheck
npm test
```

### lint-staged Configuration

```json
{
  "lint-staged": {
    "*.{ts,tsx}": ["prettier --write", "eslint --fix"],
    "*.{json,md,yml,yaml}": ["prettier --write"]
  }
}
```

### What Runs on Commit

1. **lint-staged**: Format and lint staged files only
2. **typecheck**: Full TypeScript type check
3. **test**: Full test suite (Vitest)

### Required Dev Dependencies

```json
{
  "husky": "^9.x",
  "lint-staged": "^16.x"
}
```

## Testing

### Test Framework: Vitest

- Fast, native TypeScript support
- Jest-compatible API
- Uses `@typescript-eslint/rule-tester` for ESLint rules

### Test File Location

- Tests co-located with source: `src/**/*.test.ts`
- No separate `__tests__` directory

## Project Structure

```
├── src/
│   ├── index.ts              # Plugin entry point
│   ├── rules/                # ESLint rule implementations
│   │   ├── rule-name.ts
│   │   └── rule-name.test.ts
│   └── utils/                # Shared utilities
├── dist/                     # Build output (gitignored)
├── docs/                     # Documentation
├── eslint.config.ts          # ESLint flat config
├── tsconfig.json             # TypeScript config
├── vitest.config.ts          # Vitest config
└── .prettierrc               # Prettier config
```

## NPM Scripts

- `npm run build` - Compile TypeScript
- `npm run dev` - Watch mode compilation
- `npm run lint` - Run ESLint
- `npm run lint:fix` - Run ESLint with auto-fix
- `npm run format` - Format with Prettier
- `npm run format:check` - Check formatting
- `npm run test` - Run tests
- `npm run test:watch` - Run tests in watch mode
- `npm run typecheck` - Type-check without emitting

## CI/CD

### GitHub Actions

The project uses GitHub Actions for continuous integration with three parallel jobs:

```yaml
# .github/workflows/ci.yml
jobs:
  test:        # typecheck + unit tests
  lint:        # eslint + prettier
  build:       # compile + upload artifact
```

### CI Checks

| Job | Steps |
|-----|-------|
| **test** | `npm run typecheck`, `npm test` |
| **lint** | `npm run lint`, `npm run format:check` |
| **build** | `npm run build`, upload `dist/` artifact |

### Triggers

- **Push** to `main` branch
- **Pull requests** targeting `main`

## Releasing

### release-it

The project uses `release-it` with the `@release-it/conventional-changelog` plugin for automated releases.

```bash
npm run release
```

This will:
1. Run lint, typecheck, and tests
2. Bump version based on conventional commits
3. Generate/update CHANGELOG.md
4. Create git tag
5. Push to GitHub
6. Create GitHub Release with changelog
7. Publish to npm

### Release Configuration

```json
// .release-it.json
{
  "git": {
    "commitMessage": "chore: release v${version}",
    "tagName": "v${version}"
  },
  "github": {
    "release": true
  },
  "npm": {
    "publish": true
  },
  "plugins": {
    "@release-it/conventional-changelog": {
      "preset": "conventionalcommits",
      "infile": "CHANGELOG.md"
    }
  }
}
```

### Required Dev Dependencies

```json
{
  "release-it": "^18.x",
  "@release-it/conventional-changelog": "^10.x"
}
```
